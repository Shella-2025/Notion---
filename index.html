<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Notion Visitor Dashboard</title>
  <style>
    :root{
      --card-bg:#e6dfcf;
      --text:#111;
      --muted:#444;
      --accent:#2b7a66;
      --shadow:0 10px 26px rgba(0,0,0,0.10);
      --radius:18px;
    }

    /* Notion embed å‹å–„ï¼šç½®ä¸­ + é€æ˜åº• */
    html, body{
      height:100%;
    }
    body{
      margin:0;
      display:flex;
      justify-content:center;
      align-items:center;
      background:transparent;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
      color:var(--text);
    }

    .wrap{
      width: 320px;
      max-width: 92vw;
    }

    .panel{
      background:var(--card-bg);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }

    .head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }

    .title{
      font-weight:800;
      font-size:16px;
      line-height:1.2;
    }

    .desc{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    .pill{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.55);
      color:#222;
      white-space:nowrap;
      user-select:none;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    .stat{
      border-radius:14px;
      background:rgba(255,255,255,0.45);
      padding:12px;
      min-height:62px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }

    .label{
      font-size:11px;
      color:var(--muted);
    }

    .value{
      font-weight:800;
      font-size:22px;
      color:var(--accent);
      letter-spacing:0.2px;
    }

    .foot{
      margin-top:10px;
      font-size:11px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }

    .hint{
      opacity:0.9;
    }

    .status{
      opacity:0.85;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">
      <div class="head">
        <div>
          <div class="title">ğŸ‘¾ ç€è¦½äººæ•¸å„€è¡¨æ¿</div>
          <div class="desc">æäº¤éœ€æ±‚å°±è¯ç¹«ï¼›ä¸æäº¤ä¹Ÿæ²’é—œä¿‚ï¼Œè‡³å°‘ä½ çœ‹åˆ°äº†ã€‚:D</div>
        </div>
        <div class="pill" id="pill">Syncingâ€¦</div>
      </div>

      <div class="grid">
        <div class="stat">
          <div class="label">Today</div>
          <div class="value" id="today">0</div>
        </div>

        <div class="stat">
          <div class="label">Yesterday</div>
          <div class="value" id="yesterday">0</div>
        </div>

        <div class="stat">
          <div class="label">This Week</div>
          <div class="value" id="week">0</div>
        </div>

        <div class="stat">
          <div class="label">Total</div>
          <div class="value" id="total">0</div>
        </div>
      </div>

      <div class="foot">
        <div class="hint">* è¨ˆæ•¸ç‚ºé é¢è¼‰å…¥æ¬¡æ•¸ï¼ˆå«è‡ªå·±æ¸¬è©¦ï¼‰</div>
        <div class="status" id="status">â€”</div>
      </div>
    </div>
  </div>

<script>
/**
 * âœ… çœŸçµ±è¨ˆåšæ³•ï¼ˆCountAPIï¼‰
 * - Totalï¼šå›ºå®š keyï¼Œæ¯æ¬¡æ‰“é–‹é é¢ +1
 * - Todayï¼šä»¥æ—¥æœŸ keyï¼ˆYYYY-MM-DDï¼‰ï¼Œæ¯æ¬¡æ‰“é–‹é é¢ +1
 * - Yesterdayï¼šè®€å–æ˜¨å¤©æ—¥æœŸ keyï¼ˆä¸å¢åŠ ï¼‰
 * - This Weekï¼šè®€å–ã€Œæœ¬é€±é€±ä¸€ï½ä»Šå¤©ã€æ¯æ—¥ key çš„å€¼åŠ ç¸½ï¼ˆä¸å¢åŠ ï¼‰
 *
 * ä½ åªè¦æ”¹å…©å€‹åœ°æ–¹ï¼š
 * 1) namespace: ä½ æƒ³è¦çš„å‘½åç©ºé–“ï¼ˆé¿å…æ’ keyï¼‰
 * 2) siteKey: ä½ çš„ç«™é»è­˜åˆ¥ï¼ˆåŒä¸€å€‹ widget ç”¨åŒä¸€å€‹ keyï¼‰
 */

const namespace = "shella";          // âœ… å»ºè­°æ”¹æˆä½ è‡ªå·±çš„ï¼Œä¾‹å¦‚ "sanheso"
const siteKey   = "notion-dashboard"; // âœ… å»ºè­°æ”¹æˆä½ çš„ widget åç¨±

// ---------- æ—¥æœŸå·¥å…· ----------
function pad(n){ return String(n).padStart(2, "0"); }
function ymd(d){
  const y = d.getFullYear();
  const m = pad(d.getMonth()+1);
  const day = pad(d.getDate());
  return `${y}-${m}-${day}`;
}
function startOfWeekMonday(d){
  // é€±ä¸€ç‚ºèµ·é»
  const dd = new Date(d);
  const day = dd.getDay(); // 0=Sun
  const diff = (day === 0 ? -6 : 1 - day);
  dd.setDate(dd.getDate() + diff);
  dd.setHours(0,0,0,0);
  return dd;
}
function addDays(d, n){
  const dd = new Date(d);
  dd.setDate(dd.getDate() + n);
  return dd;
}

// ---------- CountAPI å‘¼å« ----------
async function hit(key){
  const url = `https://api.countapi.xyz/hit/${encodeURIComponent(namespace)}/${encodeURIComponent(key)}`;
  const res = await fetch(url);
  return res.json(); // {value: number}
}
async function get(key){
  const url = `https://api.countapi.xyz/get/${encodeURIComponent(namespace)}/${encodeURIComponent(key)}`;
  const res = await fetch(url);
  return res.json(); // {value: number} or {error: ...}
}

// ---------- UI å‹•ç•« ----------
function animateNumber(el, target){
  target = Number.isFinite(target) ? Math.max(0, Math.floor(target)) : 0;
  const start = 0;
  const duration = 700; // ms
  const t0 = performance.now();

  function tick(now){
    const p = Math.min(1, (now - t0) / duration);
    // easeOutCubic
    const eased = 1 - Math.pow(1 - p, 3);
    const val = Math.floor(start + (target - start) * eased);
    el.textContent = val.toLocaleString();
    if(p < 1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

function setPill(text){
  document.getElementById("pill").textContent = text;
}
function setStatus(text){
  document.getElementById("status").textContent = text;
}

function safeValue(obj){
  return (obj && typeof obj.value === "number") ? obj.value : 0;
}

(async function main(){
  try{
    setPill("Updatingâ€¦");
    setStatus("loading");

    const now = new Date();
    const todayStr = ymd(now);
    const yesterdayStr = ymd(addDays(now, -1));

    // keys
    const totalKey = `${siteKey}-total`;
    const todayKey = `${siteKey}-day-${todayStr}`;
    const yKey     = `${siteKey}-day-${yesterdayStr}`;

    // âœ… æ¯æ¬¡é–‹å•Ÿï¼šTotal +1 & Today +1
    const [totalHit, todayHit] = await Promise.all([
      hit(totalKey),
      hit(todayKey),
    ]);

    // âœ… æ˜¨å¤©ï¼šåªè®€å–ï¼Œä¸å¢åŠ ï¼ˆæ²’æœ‰è³‡æ–™æ™‚è¦–ç‚º 0ï¼‰
    let yGet = await get(yKey);
    if(yGet && yGet.error) yGet = { value: 0 };

    // âœ… æœ¬é€±ï¼šé€±ä¸€ï½ä»Šå¤©çš„æ¯æ—¥å€¼åŠ ç¸½ï¼ˆåªè®€å–ï¼‰
    const monday = startOfWeekMonday(now);
    const days = [];
    for(let d = new Date(monday); d <= now; d = addDays(d, 1)){
      days.push(ymd(d));
    }

    const weekGets = await Promise.all(days.map(ds => {
      const k = `${siteKey}-day-${ds}`;
      return get(k).then(r => (r && r.error) ? ({value:0}) : r).catch(() => ({value:0}));
    }));
    const weekSum = weekGets.reduce((acc, r) => acc + safeValue(r), 0);

    // ---------- Render ----------
    animateNumber(document.getElementById("total"), safeValue(totalHit));
    animateNumber(document.getElementById("today"), safeValue(todayHit));
    animateNumber(document.getElementById("yesterday"), safeValue(yGet));
    animateNumber(document.getElementById("week"), weekSum);

    setPill(todayStr);
    setStatus("ok");
  }catch(e){
    console.error(e);
    setPill("Error");
    setStatus("failed");
  }
})();
</script>

</body>
</html>
